#! /usr/bin/env python
# -*- coding: utf-8 -*-

from PyQt4 import QtGui, QtCore
import sys
import os
import logging
import argparse
application = QtGui.QApplication([''])  # application before utilqtreactor
from util import utilqtreactor
utilqtreactor.install()
# in order that system dialog box to be in the appropriate language
translator = QtCore.QTranslator()
localelang = QtCore.QLocale.system().name()
translator.load(QtCore.QString("qt_") + localelang,
                QtCore.QLibraryInfo.location(
                    QtCore.QLibraryInfo.TranslationsPath))
application.installTranslator(translator)
# for windows, set lang
if sys.platform.startswith("win"):
    import locale
    if os.getenv('LANG') is None:
        lang, enc = locale.getdefaultlocale()
        os.environ['LANG'] = lang
from configuration import configparam as params
params.setp_appdir(os.path.realpath(os.path.dirname(__file__)))
from util.utili18n import le2mtrans  # after the set of APPDIR


def main():
    parser = argparse.ArgumentParser()

    # directory for the database
    parser.add_argument("-db", "--dirbase", action="store",
                        default=None,
                        help=le2mtrans(
                            u"Directory in which to store the database. "
                            u"This argument is not an option if several "
                            u"parts are started with arg -e"))

    # database name
    parser.add_argument("-nb", "--namebase", action="store",
                        default="data.sqlite",
                        help=le2mtrans(u"Name of the sqlite file, if not data"))

    # server port
    parser.add_argument("-p", "--port", action="store", type=int,
                        default=params.getp("SERVPORT"))

    # names of parts to load directly
    parser.add_argument("-e", "--parts", nargs='+', default=[],
                        dest="parts",
                        help=le2mtrans(u"The name(s) of the part(s) to load)."))

    # whether it is a test session or not
    parser.add_argument("-nt", "--notest", action="store_false", default=True,
                        help=le2mtrans(u"With this option the experiment is "
                                       u"launched for true"))

    # check the options ========================================================
    args = parser.parse_args()
    if args.parts:
        for e in args.parts:
            if e not in os.listdir(params.getp("PARTSDIR")):
                parser.error(le2mtrans(u"Part {p} does not exist").format(p=e))
    # vérification base de données si plusieurs expériences
    if len(args.parts) > 1 and not args.dirbase:
        parser.error(le2mtrans(u"The directory in which store the "
                               u"database has to be provided with arg -db"))

    params.setp("SERVPORT", args.port)
    options = vars(args)  # we put the args in a dict

    # creation logger ==========================================================
    logger = logging.getLogger("le2m")
    logger.setLevel(logging.DEBUG)
    formatter = logging.Formatter(
        params.getp("LOGGING_FORMATTER"),
        datefmt=params.getp("LOGGING_FORMATTER_DATE"))
    fichier_log = logging.FileHandler(
        os.path.join(params.getp("LOGDIR"), 'le2m.log'))
    fichier_log.setLevel(logging.INFO)
    fichier_log.setFormatter(formatter)
    logger.addHandler(fichier_log)
    console_log = logging.StreamHandler()
    console_log.setLevel(logging.DEBUG)
    console_log.setFormatter(formatter)
    logger.addHandler(console_log)
    logger.info(30 * "=")
    logger.info("Logger LE2M created")
    logger.info("APPDIR: {}".format(params.getp("APPDIR")))
    logger.info("PARTSDIR: {}".format(params.getp("PARTSDIR")))
    logger.info("Command ligne options: {}".format(options))

    # instanciation server
    from server.serv import Serveur

    serveur = Serveur(**options)
    serveur.start()


if __name__ == "__main__":
    main()
